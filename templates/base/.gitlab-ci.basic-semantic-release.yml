include:
    - local: /templates/base/.gitlab-ci.check-var.yml

variables:
  SEMANTIC_RELEASE_IMAGE: "node:18-buster-slim"

check-GL_TOKEN:
  stage: release
  extends: .check
  variables:
    VAR: "GL_TOKEN"
    MESSAGE: |
      "$VAR Gitlab variable has not been found. It should be present in group vars at the /skale-5 scope"


semantic-release:
  stage: release
  needs:
    - check-GL_TOKEN
  image: ${SEMANTIC_RELEASE_IMAGE}
  rules:
    - if: '($CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master") && $CI_PIPELINE_SOURCE == "push"'
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git-core ca-certificates
    - npm install -g semantic-release @semantic-release/gitlab
    - npm install -g semantic-release @semantic-release/changelog
    - npm install -g semantic-release @semantic-release/git

  script:
    - semantic-release
  variables:
    GL_TOKEN: ${GL_TOKEN}
