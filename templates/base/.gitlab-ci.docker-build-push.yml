# https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
kaniko:image:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.5.1-debug
    entrypoint: [""]
  before_script:
    - if [ "${CI_COMMIT_TAG}" == "" ]; then export VERSION="latest"; else export VERSION="${CI_COMMIT_TAG}"; fi
  script:
    - export DOCKER_AUTH=$(echo -n ${DOCKER_USER}:${DOCKER_PASS} | base64)
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"${DOCKER_AUTH}\"}}}" > /kaniko/.docker/config.json
    - echo "Docker image skale5/${CI_PROJECT_NAME}:${VERSION} being generated from ${CI_PROJECT_DIR}/${DOCKERFILE_NAME:-Dockerfile}"
    - /kaniko/executor --context ${CI_PROJECT_DIR} --dockerfile ${CI_PROJECT_DIR}/${DOCKERFILE_NAME:-Dockerfile} --snapshotMode=redo --destination skale5/${CI_PROJECT_NAME}:${VERSION}
